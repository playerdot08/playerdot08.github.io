<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Catch the Falling Wine</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background-color: #000;
    font-family: sans-serif;
    touch-action: none;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background-size: cover;
    touch-action: none;
  }
  #nameInput {
    position: absolute;
    text-align: center;
    border: none;
    outline: none;
    background: transparent;
    color: white;
    display: none;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<input type="text" id="nameInput" placeholder="Enter name" />

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const nameInput = document.getElementById("nameInput");
let newWidth, newHeight;

// 화면 크기 조정 (720x1280 비율 유지)
function resizeCanvas() {
  const width = window.innerWidth;
  const height = window.innerHeight;
  const aspectRatio = 720 / 1280;
  newWidth = width;
  newHeight = width / aspectRatio;
  if (newHeight > height) { newHeight = height; newWidth = height * aspectRatio; }

  canvas.style.width = newWidth + "px";
  canvas.style.height = newHeight + "px";
  canvas.width = 720;
  canvas.height = 1280;
  updateNameInputPosition();
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// 이미지 로드
const startBg = new Image(); startBg.src = "image/background.png";
const startBtn = new Image(); startBtn.src = "image/start.png";
const assImg = new Image(); assImg.src = "image/ass.png";
const nameImg = new Image(); nameImg.src = "image/name.png";
const titleImg = new Image(); titleImg.src = "image/title.png";

const gameBg = new Image(); gameBg.src = "image/background_f.png";
const endBg = new Image(); endBg.src = "image/end_f.png";
const scoreImg = new Image(); scoreImg.src = "image/score.png";
const liveImg = new Image(); liveImg.src = "image/live.png";
const noLiveImg = new Image(); noLiveImg.src = "image/noLive.png";
const finalScoreImg = new Image(); finalScoreImg.src = "image/finalScore.png";
const topImg = new Image(); topImg.src = "image/top.png";

const playerImg = new Image(); playerImg.src = "image/player.png";
const wineImg = new Image(); wineImg.src = "image/wine.png";

// 게임 변수
const player = { x: (720-141)/2, y: 1280-354, width:141, height:354, speed:7 };
let items = [], score=0, lives=3, spawnInterval=4000, fallSpeed=5.5;
let lastSpawn=0, lastSpawnIntervalDecrease=0;
let gameState = "inputName"; // inputName -> assClicked -> playing -> end
let assClicked = false;
const keys = {};
document.addEventListener("keydown", e=>keys[e.key]=true);
document.addEventListener("keyup", e=>keys[e.key]=false);

// 터치 이동
canvas.addEventListener("touchmove", e=>{
  const rect = canvas.getBoundingClientRect();
  const touchX = e.touches[0].clientX - rect.left;
  player.x = Math.min(Math.max(touchX - player.width/2,0), canvas.width - player.width);
  e.preventDefault();
}, { passive:false });

// 이름 입력 위치 고정
function updateNameInputPosition() {
  const nameX = (canvas.height - 400)/2 + 100;
  const nameY = (canvas.height - 230)/2 + 54;
  const scaleX = newWidth / canvas.width;
  const scaleY = newHeight / canvas.height;
  nameInput.style.left = (nameX * scaleX) + "px";
  nameInput.style.top = (nameY * scaleY) + "px";
  nameInput.style.width = (325.6 * scaleX) + "px";
  nameInput.style.height = (69 * scaleY) + "px";
  nameInput.style.fontSize = (32 * scaleY) + "px";
}

// ass 버튼 X 고정
const assX = (canvas.width - 70)/2;

// 캔버스 클릭
canvas.addEventListener("click", e=>{
  const rect = canvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const x = clickX * scaleX;
  const y = clickY * scaleY;

  if(gameState === "inputName" && !assClicked) {
    const assY = (canvas.height - 230)/2 + 149;
    if(x >= assX && x <= assX + 70 && y >= assY && y <= assY + 50) {
      if(nameInput.value.trim() !== "") {
        assClicked = true;
        nameInput.style.display = "none";
      }
    }
  } else if(gameState === "inputName" && assClicked) {
    const btnX = (canvas.width-509)/2;
    const btnY = titleY + 450; // 시작버튼 Y 위치
    if(x >= btnX && x <= btnX+509 && y >= btnY && y <= btnY+207){
      gameState = "playing";
      score=0; lives=3; items=[];
      lastSpawn=0; lastSpawnIntervalDecrease=0; fallSpeed=5.5;
    }
  } else if(gameState === "end") {
    ctx.drawImage(endBg,0,0,canvas.width,canvas.height);

    const finalW=420, finalH=200;
    const finalX=(canvas.width-finalW)/2;
    const finalY=100;
    ctx.drawImage(finalScoreImg,finalX,finalY,finalW,finalH);


    drawTop(); // ← 이 위치에서 top 이미지와 랭킹 표시
}

});

// 아이템 생성
function spawnItem() {
  const x = Math.random()*(canvas.width-48);
  items.push({ x, y:-114, width:48, height:114, speed:fallSpeed });
}
function drawPlayer() { ctx.drawImage(playerImg, player.x, player.y, player.width, player.height); }
function updateAndDrawItems() {
  for(let i=items.length-1;i>=0;i--){
    const item = items[i]; item.y += item.speed;
    ctx.drawImage(wineImg,item.x,item.y,item.width,item.height);
    const catchArea = {x:player.x, y:player.y, width:player.width, height:81};
    if(item.y+item.height>=catchArea.y && item.y<=catchArea.y+catchArea.height &&
       item.x<catchArea.x+catchArea.width && item.x+item.width>catchArea.x){
      score++; items.splice(i,1); continue;
    }
    if(item.y>canvas.height){ items.splice(i,1); lives--; if(lives<=0) { saveScore(nameInput.value, score); gameState="end"; } }
  }
}
function updatePlayer() { if(keys["ArrowLeft"] && player.x>0) player.x -= player.speed;
  if(keys["ArrowRight"] && player.x<canvas.width-player.width) player.x += player.speed; }
function drawHUD() {
  ctx.drawImage(scoreImg,0,0,200,50);
  ctx.fillStyle="white"; ctx.font="28px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(score,100,25);
  for(let i=0;i<3;i++){ const img = i<lives ? liveImg:noLiveImg; ctx.drawImage(img,250+60*i,0,50,50); }
}

// localStorage 저장
function saveScore(name, score){
  if(!name) return;
  let playersList = JSON.parse(localStorage.getItem("playersList")) || [];
  playersList.push({name, score});
  localStorage.setItem("playersList", JSON.stringify(playersList));
}

// top 이미지 안 점수 표시
function drawTop() {
  const topW = 500, topH = 700;
  const topX = (canvas.width - topW) / 2;
  const finalY = 100, finalH = 200; // 최종 점수 이미지 기준
  const topY = finalY + finalH + 20; // top 이미지 Y 위치
  ctx.drawImage(topImg, topX, topY, topW, topH);

  let playersList = JSON.parse(localStorage.getItem("playersList")) || [];
  // 점수 내림차순, 동점은 저장순서 유지
  playersList.sort((a,b) => b.score - a.score);

  ctx.fillStyle = "white";
  ctx.font = "36px Arial";
  ctx.textBaseline = "middle";

  for(let i=0;i<playersList.length;i++){
    const player = playersList[i];
    const rankY = topY + 120 + i*60;
    const text = `${i+1}. ${player.name} - ${player.score}`;
    const textWidth = ctx.measureText(text).width; // 텍스트 너비 계산
    const centerX = topX + topW/2;   // top 이미지 기준 x축 중앙
    ctx.fillText(text, centerX, rankY);
  }
}


const titleW=450, titleH=350;
const titleX=(canvas.width-titleW)/2;
const titleY=300;

function gameLoop(timestamp){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(gameState==="inputName") {
    ctx.drawImage(startBg,0,0,canvas.width,canvas.height);
    ctx.drawImage(titleImg,titleX,titleY,titleW,titleH);

    if(!assClicked){
      const nameImgX=(canvas.width-400)/2;
      const nameImgY=(canvas.height-230)/2;
      ctx.drawImage(nameImg,nameImgX,nameImgY,400,230);
      const assY = (canvas.height-230)/2 + 149;
      ctx.drawImage(assImg, assX, assY, 70,50);
      nameInput.style.display = "block";
    }
    // start 버튼은 항상 보이지만 클릭은 ass 클릭 이후 가능
    const btnX=(canvas.width-509)/2;
    const btnY=titleY + 450;
    ctx.drawImage(startBtn, btnX, btnY, 509, 207);

  } else if(gameState==="playing") {
    ctx.drawImage(gameBg,0,0,canvas.width,canvas.height);
    updatePlayer(); drawPlayer(); updateAndDrawItems(); drawHUD();
    if(!lastSpawn) lastSpawn=timestamp;
    if(!lastSpawnIntervalDecrease) lastSpawnIntervalDecrease=timestamp;
    if(timestamp-lastSpawnIntervalDecrease>=3000){ spawnInterval=Math.max(1000,spawnInterval-1300); lastSpawnIntervalDecrease=timestamp; }
    if(timestamp-lastSpawn>spawnInterval){ spawnItem(); lastSpawn=timestamp; }
    fallSpeed += 0.00026;

  } else if(gameState==="end") {
    ctx.drawImage(endBg,0,0,canvas.width,canvas.height);
    const finalW=420, finalH=200;
    const finalX=(canvas.width-finalW)/2;
    const finalY=100;
    ctx.drawImage(finalScoreImg,finalX,finalY,finalW,finalH);
    ctx.fillStyle="white"; ctx.font="48px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(score, finalX+finalW/2, finalY+finalH/2+28);
    drawTop();
  }

  requestAnimationFrame(gameLoop);
}

requestAnimationFrame(gameLoop);
</script>
</body>
</html>
